#!/bin/bash

# devcontainerä½œæˆå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -euo pipefail

echo "ğŸš€ devcontainer ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."

# .tool-versionsã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if [ -f ".tool-versions" ]; then
    echo "ğŸ”§ .tool-versionsã‹ã‚‰Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    asdf install
    echo "âœ… æŒ‡å®šã•ã‚ŒãŸNode.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸ"
else
    echo "âš ï¸  .tool-versionsãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚LTSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
    asdf install nodejs lts
    echo "nodejs lts" > .tool-versions
fi

# Node.jsã¨npmã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
echo "ğŸ“‹ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
node --version
npm --version

# package.jsonãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
if [ ! -f "package.json" ]; then
    echo "ğŸ“¦ ã‚µãƒ³ãƒ—ãƒ«ã®Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆä¸­..."

    # Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
    npx create-next-app@latest . \
        --typescript \
        --tailwind \
        --eslint \
        --app \
        --src-dir \
        --import-alias "@/*" \
        --use-npm

    echo "âœ… Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
else
    echo "ğŸ“¦ æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."

    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’è‡ªå‹•æ¤œå‡ºã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    if [ -f "pnpm-lock.yaml" ]; then
        echo "pnpm ã‚’ä½¿ç”¨ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        pnpm install
    elif [ -f "yarn.lock" ]; then
        echo "yarn ã‚’ä½¿ç”¨ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        yarn install
    else
        echo "npm ã‚’ä½¿ç”¨ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        npm install
    fi
    echo "âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
fi

# é–‹ç™ºç”¨ã®è¿½åŠ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "ğŸ› ï¸  é–‹ç™ºç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ä¸­..."
npm install --save-dev \
    @types/react \
    @types/react-dom \
    prettier \
    eslint-config-prettier

# prettierè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
if [ ! -f ".prettierrc" ]; then
    cat > .prettierrc << 'EOF'
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2
}
EOF
fi

echo "âœ… devcontainer ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo "ğŸ’¡ é–‹ç™ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯: npm run dev"
